name: CD - Deploy to Railway

on:
  push:
    branches: [ main, dev ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev       
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    environment:
      name: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'dev') }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deployment info
      run: |
        echo "üöÄ Starting deployment..."
        echo "üìå Branch: ${{ github.ref_name }}"
        echo "üåç Target Environment: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'dev') }}"
        echo "üìù Commit: ${{ github.sha }}"

    - name: Install Railway CLI
      run: |
        curl -fsSL https://railway.app/install.sh | sh

    # --- DEV DEPLOYMENT ---
    - name: Deploy to Railway Dev
      if: ${{ inputs.environment == 'dev' || (github.event_name == 'push' && github.ref == 'refs/heads/dev') }}
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_DEV }}
      run: |
        echo "üöÇ Deploying to Railway DEV..."
        # UPDATED: --environment=dev
        railway up --service=${{ secrets.RAILWAY_SERVICE_DEV }} --environment=dev
        echo "‚úÖ Deployed to DEV environment"

    # --- PRODUCTION DEPLOYMENT ---
    - name: Deploy to Railway Production
      if: ${{ inputs.environment == 'production' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_PROD }}
      run: |
        echo "üöÇ Deploying to Railway PRODUCTION..."
        railway up --service=${{ secrets.RAILWAY_SERVICE_PROD }} --environment=production
        echo "‚úÖ Deployed to PRODUCTION environment"

    - name: Notification
      if: always()
      run: |
        echo "Status: ${{ job.status }}"
        echo "Environment: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'dev') }}"